#!/bin/bash
set -euo pipefail

# Remember current session if we're inside tmux
last_session=""
if [ -n "${TMUX-}" ]; then
  last_session=$(tmux display-message -p '#S')
fi

# Pick sessions to kill
sessions_to_kill="$(
  tmux list-sessions -F '#{session_name} #{session_attached}' |
    awk '{
      if ($2==1) {
        # attached session in bold green
        printf "\033[38;5;223m%s\033[0m\n", $1
      } else {
        # not attached session normal
        print $1
      }
    }' |
    fzf \
      --ansi \
      --no-border \
      --height=100% \
      --bind 'ctrl-/:toggle-preview' \
      --exact \
      --reverse \
      --multi \
      --header "Kill session >" \
      --preview-window=right,70%,border-none \
      --preview 'tmux capture-pane -pt {} | bat --color=always -pl sh' ||
    true
)"

# If nothing selected, exit quietly
[ -z "$sessions_to_kill" ] && exit 0


# TODO: Use a tmux hooks instead of the following ?

# If we're inside tmux and our current session is going to be killed,
# switch to a different session first (or create a rescue one).
if [ -n "${TMUX-}" ] && printf '%s\n' "$sessions_to_kill" | grep -Fxq "$last_session"; then
  # Find a session not selected for killing
  alt_session="$(
    tmux list-sessions -F '#S' | while IFS= read -r s; do
      if ! printf '%s\n' "$sessions_to_kill" | grep -Fxq "$s"; then
        printf '%s\n' "$s"
        break
      fi
    done
  )"

  if [ -z "$alt_session" ]; then
    # No safe session exists; create a rescue session
    alt_session="rescue-$(date +%s)"
    tmux new-session -ds "$alt_session"
  fi

  tmux switch-client -t "$alt_session"
fi

# Kill the selected sessions
while IFS= read -r s; do
  [ -n "$s" ] && tmux kill-session -t "$s"
done <<<"$sessions_to_kill"
