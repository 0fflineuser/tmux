#!/bin/bash
set -euo pipefail

get_current_tmux_session() {
  [[ -n "${TMUX:-}" ]] && tmux display-message -p '#S' || echo ""
}

choose_sessions_to_kill() {
  tmux list-sessions -F '#{session_name} #{session_attached}' |
    awk '{
      if ($2>=1)
        printf "\033[38;5;223m%s\033[0m\n", $1;
      else
        print $1;
    }' |
    # grep -v '^scratch-' |
    sort -r |
    fzf \
      --ansi \
      --no-border \
      --height=100% \
      --bind 'ctrl-/:toggle-preview' \
      --exact \
      --reverse \
      --multi \
      --cycle \
      --header "Kill session >" \
      --preview-window=right,70%,border-none \
      --preview 'tmux capture-pane -pt {} | bat --color=always -pl sh' ||
    true
}

switch_tmux_client_if_needed() {
  local current_session="$1"
  local sessions_to_kill="$2"

  if [[ -z "${TMUX:-}" ]]; then
    return
  fi

  if printf '%s\n' "$sessions_to_kill" | grep -Fxq "$current_session"; then
    # Find alternate session
    local alt_session=""
    while read -r s; do
      if ! printf '%s\n' "$sessions_to_kill" | grep -Fxq "$s"; then
        alt_session="$s"
        break
      fi
    done < <(tmux list-sessions -F '#S')

    # If no alternate session found, create a rescue one
    if [[ -z "$alt_session" ]]; then
      alt_session="rescue-$(date +%s)"
      (
        TMUX=''
        tmux new-session -ds "$alt_session" -c "$HOME"
      )
    fi

    tmux switch-client -t "$alt_session"
  fi
}

kill_tmux_sessions() {
  local sessions_to_kill="$1"
  while IFS= read -r s; do
    [[ -n "$s" ]] && tmux kill-session -t "$s"
  done <<<"$sessions_to_kill"
}

main() {
  local current_session
  current_session="$(get_current_tmux_session)"

  local sessions_to_kill
  sessions_to_kill="$(choose_sessions_to_kill)"

  [[ -z "$sessions_to_kill" ]] && exit 0

  switch_tmux_client_if_needed "$current_session" "$sessions_to_kill"
  kill_tmux_sessions "$sessions_to_kill"
}

main "$@"
